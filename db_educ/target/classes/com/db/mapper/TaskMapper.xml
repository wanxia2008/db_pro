<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.db.service.TaskService">
	<resultMap type="com.db.entity.Task" id="TaskMap">
		<result column="task_id" property="taskId" jdbcType="INTEGER" />
		<result column="task_title" property="taskTitle" jdbcType="VARCHAR" />
		<result column="requirement" property="requirement" jdbcType="VARCHAR" />
		<result column="task_count" property="taskCount" jdbcType="INTEGER" />
		<result column="rule" property="rule" jdbcType="INTEGER" />
		<result column="task_type" property="taskType" jdbcType="INTEGER" />
		<result column="task_object_class" property="taskObjectClass"
			jdbcType="VARCHAR" />
		<result column="task_object_stu" property="taskObjectStu"
			jdbcType="INTEGER" />
		<result column="start_time" property="startTime" jdbcType="VARCHAR" />
		<result column="end_time" property="endTime" jdbcType="INTEGER" />
		<result column="create_time" property="createTime" />
		<result column="update_time" property="updateTime" />
		<result column="create_user" property="createUser" jdbcType="INTEGER" />
		<result column="task_status" property="taskStatus" jdbcType="INTEGER" />
		
		<association property="taskName" javaType="com.db.entity.TaskType">
			<id column="type_id" property="typeId" jdbcType="INTEGER" />
			<result column="tasktype_name" property="taskTypeName"
				jdbcType="VARCHAR" />
		</association>
		
		<association property="paperInfo" javaType="com.db.entity.PaperInfo">
			<id column="pi_id" property="piId" jdbcType="INTEGER" />
			<result column="pi_name" property="piName" jdbcType="VARCHAR" />
		</association>
		
		<association property="classNo" javaType="com.db.entity.ClassNo">
			<id column="class_id" property="classId" jdbcType="INTEGER" />
			<result column="class_name" property="className" jdbcType="VARCHAR" />
		</association>
		
		<association property="taskRule" javaType="com.db.entity.TaskRule">
			<id column="rule_id" property="ruleId" jdbcType="INTEGER" />
			<result column="rule_name" property="ruleName" jdbcType="VARCHAR" />
		</association>
	</resultMap>


	<!-- 我的任务列表 -->
	<select id="taskList" resultMap="TaskMap">
		select * from td_task t left join td_task_type ty on
		t.task_type=ty.type_id
		left join tb_paper_info tpi on t.task_count=tpi.pi_id
		left join tb_task_rule tr on t.rule=tr.rule_id
		where t.create_user=#{teacherId}
		<if test="taskTitle != null and taskTitle != ''">
			and t.task_title like CONCAT('%','${taskTitle}','%')
		</if>
		<if test="taskType != null and taskType != ''">
			and t.task_type=#{taskType}
		</if>

		order by t.create_time desc limit #{pageNo},#{pageSize}
	</select>

	<!-- 查看个人信息 -->
	<select id="getTaskById" resultMap="TaskMap">
		select * from td_task t left join td_task_type ty on t.task_type=ty.type_id
		left join tb_paper_info tpi on t.task_count=tpi.pi_id left join
		tb_class_no tcn on t.task_object_class=tcn.class_id where
		t.task_id=#{taskId}
	</select>

	<!-- 新增任务 -->
	<insert id="addTask" parameterType="com.db.entity.Task"
		useGeneratedKeys="true" keyProperty="taskId">
		insert into
		td_task(task_title,requirement,task_count,rule,task_type,start_time,create_time,create_user
		<if test="taskObjectClass != '' and taskObjectClass != null">
			,task_object_class
		</if>
		<if test="taskObjectStu != '' and taskObjectStu != null">
			,task_object_stu
		</if>
		<if test="taskStatus != null">
			,task_status
		</if>
		)
		values(#{taskTitle},#{requirement},#{taskCount},#{rule},#{taskType},#{startTime},#{createTime},#{createUser}
		<if test="taskObjectClass != '' and taskObjectClass != null">
			,#{taskObjectClass}
		</if>
		<if test="taskObjectStu != '' and taskObjectStu != null">
			,#{taskObjectStu}
		</if>
		<if test="taskStatus != null">
			,#{taskStatus}
		</if>
		)
	</insert>

	<!-- 删除任务 -->
	<delete id="deleteTaskById" parameterType="java.lang.Integer">
		delete from td_task where task_id=#{taskId}
	</delete>
	<!-- 修改任务 -->
	<update id="updateTask" parameterType="com.db.entity.Task">
		update td_task
		<set>
			update_time=#{updateTime},
			<if test="taskTitle != null and taskTitle!=''">
				task_title=#{taskTitle}
			</if>
			<if test="requirement != null and requirement!=''">
				,requirement=#{requirement}
			</if>
			<if test="taskCount != null and taskCount!=''">
				,task_count=#{taskCount}
			</if>
			<if test="taskType != null and taskType!=''">
				,task_type=#{taskType}
			</if>
			<if test="rule != null and rule!=''">
				,rule=#{rule}
			</if>
			<if test="taskType != null and taskType !=''">
				,task_type=#{taskType}
			</if>
			<if test="taskObjectClass != null and taskObjectClass !=''">
				,task_object_class=#{taskObjectClass}
			</if>
			<if test="taskObjectStu != null and taskObjectStu !=''">
				,task_object_stu=#{taskObjectStu}
			</if>
			<if test="startTime != null and startTime !=''">
				,start_time=#{startTime}
			</if>
			<if test="endTime != null">
				,end_time=#{endTime}
			</if>
			<if test="taskStatus != null">
				,task_status=#{taskStatus}
			</if>
		</set>
		where task_id=#{taskId}
	</update>

	<select id="getCount" resultType="int">
		select count(*) from td_task where 1=1
		<if test="taskTitle != null and taskTitle != ''">
			and task_title like CONCAT('%','${taskTitle}','%')
		</if>
		<if test="taskType != null">
			and task_type=#{taskType}
		</if>
	</select>

	<select id="getalltask" parameterType="Integer" resultMap="TaskMap">
		select * from td_task where 1=1
		<if test="pageNo != null and pageSize != null">
		limit #{pageNo},#{pageSize};
		</if>
	</select>
	<!--查出要准备开启的任务  -->
	<select id="getStarTaskList" resultMap="TaskMap">
	select * from td_task where task_status=0
	</select>
	<select id="getTaskType" resultMap="TaskMap">
		select * from td_task where task_type=#{taskType}
	</select>
	<select id="getRuleId" resultMap="TaskMap">
		select * from td_task where rule=#{ruleId}
	</select>
	<select id="seeGetCount" resultType="int">
		select count(*) from td_task where create_user=#{teacherId}
		<if test="taskTitle != null and taskTitle != ''">
			and task_title like CONCAT('%','${taskTitle}','%')
		</if>
		<if test="taskType != null">
			and task_type=#{taskType}
		</if>
	</select>
	<select id="getTaskList" resultMap="TaskMap">
		select * from td_task t left join td_task_type ty on
		t.task_type=ty.type_id
		left join tb_paper_info tpi on t.task_count=tpi.pi_id
		left join tb_task_rule tr on t.rule=tr.rule_id
		where 1=1
		<if test="taskTitle != null and taskTitle != ''">
			and t.task_title like CONCAT('%','${taskTitle}','%')
		</if>
		<if test="taskType != null">
			and t.task_type=#{taskType}
		</if>

		order by t.create_time desc limit #{pageNo},#{pageSize}
	</select>
</mapper>