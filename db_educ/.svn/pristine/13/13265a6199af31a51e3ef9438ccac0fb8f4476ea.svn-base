<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.db.service.MyMistakesService">
	<resultMap id="MyMistakesMap" type="com.db.entity.MyMistakes">
		<result column="mistakes_id" property="mistakesId" jdbcType="INTEGER" />
		<result column="student_id" property="studentId" jdbcType="INTEGER" />
		<result column="mistakes_number" property="mistakesNumber"
			jdbcType="INTEGER" />
		<result column="topic_type" property="topicType" jdbcType="INTEGER" />
		<result column="current_mistakes" property="currentMistakes"
			jdbcType="INTEGER" />
		<result column="question_id" property="questionId" jdbcType="INTEGER" />
		<result column="value" property="value" jdbcType="DOUBLE" />
		<result column="homework_id" property="homeworkId" jdbcType="INTEGER" />
		<result column="paper_id" property="paperId" jdbcType="INTEGER" />
		<result column="class_id" property="classId" jdbcType="INTEGER" />
		<result column="create_time" property="createTime" />
		<result column="update_time" property="updateTime" />
		<result column="subject_id" property="subjectId" jdbcType="INTEGER" />
		<result column="status" property="status" jdbcType="INTEGER" />
		
		
		<association property="questionsType" javaType="com.db.entity.QuestionsType">
			<id property="topicId" column="topic_id" />
			<result property="topicName" column="topic_name" />
			<result property="createTime" column="create_time" />
			<result property="updateTime" column="update_time" />
			<result property="typicOrder" column="typic_order" />
		</association>
		<association property="questionSingleChoice" javaType="com.db.entity.QuestionSingleChoice">
			<id column="choice_id" property="choiceId" jdbcType="INTEGER" />
			<result column="choice_desc" property="choiceDesc" jdbcType="VARCHAR" />
			<result column="choice_optionA" property="OptionA" jdbcType="VARCHAR" />
			<result column="choice_optionB" property="OptionB" jdbcType="VARCHAR" />
			<result column="choice_optionC" property="OptionC" jdbcType="VARCHAR" />
			<result column="choice_optionD" property="OptionD" jdbcType="VARCHAR" />
			<result column="choice_answer" property="answer" jdbcType="VARCHAR" />
			<result column="choice_answer_desc" property="answerDesc"
				jdbcType="VARCHAR" />
			<result column="subject" property="subject" jdbcType="INTEGER" />
			<result column="question_degree" property="degree" jdbcType="INTEGER" />
			<result column="question_type" property="type" jdbcType="INTEGER" />
			<result column="question_source" property="source" jdbcType="INTEGER" />
			<result column="question_score" property="score" jdbcType="FLOAT" />
			<result column="tag_id" property="tag" jdbcType="VARCHAR" />
			<result column="ispublic" property="ispublic" jdbcType="INTEGER" />
		</association>
		<association property="questionMulitChoice" javaType="com.db.entity.QuestionMulitChoice">
			<id column="choice_id" property="choiceId" jdbcType="INTEGER" />
			<result column="choice_desc" property="choiceDesc1" jdbcType="VARCHAR" />
			<result column="choice_optionA" property="OptionA1" jdbcType="VARCHAR" />
			<result column="choice_optionB" property="OptionB1" jdbcType="VARCHAR" />
			<result column="choice_optionC" property="OptionC1" jdbcType="VARCHAR" />
			<result column="choice_optionD" property="OptionD1" jdbcType="VARCHAR" />
			<result column="choice_answer" property="answer1" jdbcType="VARCHAR" />
			<result column="choice_answer_desc" property="answerDesc1"
				jdbcType="VARCHAR" />
			<result column="subject" property="subject" jdbcType="INTEGER" />
			<result column="question_degree" property="degree1" jdbcType="INTEGER" />
			<result column="question_type" property="type" jdbcType="INTEGER" />
			<result column="question_source" property="source1" jdbcType="INTEGER" />
			<result column="question_score" property="score1" jdbcType="FLOAT" />
			<result column="tag_id" property="tag1" jdbcType="VARCHAR" />
			<result column="teacher_id" property="teacherId" jdbcType="INTEGER" />
			<result column="ispublic" property="ispublic1" jdbcType="INTEGER" />
		</association>
		<association property="questionJudge" javaType="com.db.entity.QuestionJudge">
			<id column="judge_id" property="judgeId" jdbcType="INTEGER" />
			<result column="judge_desc" property="judgeDesc" jdbcType="VARCHAR" />
			<result column="judge_answer" property="answer2" jdbcType="INTEGER" />
			<result column="judge_answer_desc" property="answerDesc2"
				jdbcType="VARCHAR" />
			<result column="subject" property="subject" jdbcType="INTEGER" />
			<result column="question_degree" property="degree2" jdbcType="INTEGER" />
			<result column="question_type" property="type" jdbcType="INTEGER" />
			<result column="question_source" property="source2" jdbcType="INTEGER" />
			<result column="question_score" property="score2" jdbcType="FLOAT" />
			<result column="tag_id" property="tag2" jdbcType="VARCHAR" />
			<result column="teacher_id" property="teacherId" jdbcType="INTEGER" />
			<result column="ispublic" property="ispublic2" jdbcType="INTEGER" />
		</association>
		<association property="questionRead" javaType="com.db.entity.QuestionRead">
			<id column="read_id" property="readId" jdbcType="INTEGER" />
			<result column="read_desc" property="readDesc" jdbcType="VARCHAR" />
			<result column="read_optiontitle" property="Optiontitle"
				jdbcType="VARCHAR" />
			<result column="read_optionA" property="OptionA_read"
				jdbcType="VARCHAR" />
			<result column="read_optionB" property="OptionB_read"
				jdbcType="VARCHAR" />
			<result column="read_optionC" property="OptionC_read"
				jdbcType="VARCHAR" />
			<result column="read_optionD" property="OptionD_read"
				jdbcType="VARCHAR" />
			<result column="read_answer" property="answer_read" jdbcType="VARCHAR" />
			<result column="read_answer_desc" property="answerDesc_read"
				jdbcType="VARCHAR" />
			<result column="parent_id" property="parentId" jdbcType="INTEGER" />
			<result column="subject" property="subject" jdbcType="INTEGER" />
			<result column="question_degree" property="degree_read"
				jdbcType="INTEGER" />
			<result column="question_type" property="type" jdbcType="INTEGER" />
			<result column="question_source" property="source_read"
				jdbcType="INTEGER" />
			<result column="question_score" property="score_read"
				jdbcType="FLOAT" />
			<result column="tag_id" property="tag_read" jdbcType="VARCHAR" />
			<result column="teacher_id" property="teacherId" jdbcType="INTEGER" />
			<result column="ispublic" property="ispublic_read" jdbcType="INTEGER" />
		</association>
		<association property="paperInfo" javaType="com.db.entity.PaperInfo">
			<id column="pi_id" property="piId" jdbcType="INTEGER" />
			<result column="pi_name" property="piName" jdbcType="VARCHAR" />
			<result column="subject" property="subject" jdbcType="INTEGER" />
			<result column="pi_type" property="piType" jdbcType="INTEGER" />
			<result column="grade" property="grade" jdbcType="INTEGER" />
			<result column="science" property="science" jdbcType="INTEGER" />
			<result column="used_times" property="usedTimes" jdbcType="INTEGER" />
			<result column="is_public" property="isPublic" jdbcType="INTEGER" />
		</association>
		<association property="questionFill" javaType="com.db.entity.QuestionFill">
			<id column="fill_id" property="fillId" jdbcType="INTEGER" />
		<result column="fill_title" property="fillTitle" jdbcType="VARCHAR" />
		<result column="fill_answer" property="fillAnswer" jdbcType="VARCHAR" />
		<result column="answer_analysis" property="answerAnalysis"
			jdbcType="VARCHAR" />
		<result column="fill_id" property="fillId" jdbcType="INTEGER" />
		<result column="question_type" property="type" jdbcType="INTEGER" />
		<result column="question_source" property="fillSourse"
			jdbcType="INTEGER" />
		<result column="tag_id" property="tagId" jdbcType="VARCHAR" />
		</association>
	</resultMap>


	<!-- 我的错题列表 -->
	<select id="myMistakesList" resultMap="MyMistakesMap">
		select * from
		tb_my_mistakes m left join tb_questions_type q on
		m.question_id=q.topic_id where m.student_id=#{0} limit #{1},#{2}
	</select>

	<select id="kesListdetails" resultMap="MyMistakesMap">
		select * from
		tb_my_mistakes m left join tb_question_singlechoice qs on
		m.question_id=qs.choice_id
		left join tb_questions_type qt on
		m.topic_type=qt.topic_id where
		m.student_id=#{0} limit #{1},#{2}
	</select>

	<select id="getMyAllScoreBystuId" resultType="Integer">
		select
		COALESCE(sum(value),0) from tb_my_mistakes tm left join tb_paper_info tp
		on tm.paper_id=tp.pi_id where
		tm.student_id=#{studentId} and
		tm.paper_id=#{paperId} <!-- and (tp.pi_type=2 or tp.pi_type=3); -->
	</select>

	<select id="getMyScoreBystuId" resultType="Integer">
		select
		COALESCE(sum(value),0) from tb_my_mistakes tm left join tb_paper_info tp
		on tm.paper_id=tp.pi_id where tm.paper_id=#{paperId}
		<if test="studentId!=null">
			and tm.student_id=#{studentId} 
		</if>
		and tm.topic_type=#{topicType}
		 <!-- and (tp.pi_type=2 or tp.pi_type=3); --> 
	</select>

	<select id="getMyRightQuestionBystuId" resultType="Integer">
		select
		COALESCE(sum(value),0) from tb_my_mistakes tm left join tb_paper_info tp
		on tm.paper_id=tp.pi_id where
		tm.student_id=#{studentId} and tm.topic_type=#{topicType} and tm.status=1 and 
		tm.paper_id=#{paperId} <!-- and (tp.pi_type=2 or tp.pi_type=3); -->
	</select>
	<insert id="saveMyMistakes" parameterType="com.db.entity.MyMistakes">
		insert into tb_my_mistakes (student_id,create_time,status,question_id,subject_id
		<if test="mistakesNumber != null and mistakesNumber != ''">
   <![CDATA[,mistakes_number]]>
		</if>
		<if test="currentMistakes != null and currentMistakes != ''">
   <![CDATA[,current_mistakes]]>
		</if>
		<if test="value != null and value != ''">
   <![CDATA[,value]]>
		</if>
		<if test="paperId != null and paperId != ''">
   <![CDATA[,paper_id]]>
		</if>
		<if test="classId != null and classId != ''">
   <![CDATA[,class_id]]>
		</if>
		<if test="topicType != null and topicType != ''">
   <![CDATA[,topic_type]]>
		</if>
		)
		values(#{studentId},#{createTime},#{status},#{questionId},#{subjectId}
		<if test="mistakesNumber != null and mistakesNumber != ''">
   <![CDATA[,#{mistakesNumber}]]>
		</if>
		<if test="currentMistakes != null and currentMistakes != ''">
   <![CDATA[,#{currentMistakes}]]>
		</if>
		<if test="value != null and value != ''">
   <![CDATA[,#{value}]]>
		</if>
		<if test="paperId != null and paperId != ''">
   <![CDATA[,#{paperId}]]>
		</if>
		<if test="classId != null and classId != ''">
   <![CDATA[,#{classId}]]>
		</if>
		<if test="topicType != null and topicType != ''">
   <![CDATA[,#{topicType}]]>
		</if>
		)
	</insert>
	<select id="findMyMistakesByIdType" resultType="int">
		select
		count(mistakes_number) as mistakesNumber from tb_my_mistakes
		where
		student_id=#{0} and topic_type=#{1}
	</select>
	<delete id="removeMistakes" parameterType="java.lang.Integer">
		delete from
		tb_my_mistakes where mistakes_id=#{mistakesId}
	</delete>
	<select id="findMyMistakesById" resultMap="MyMistakesMap">
		select * from
		tb_my_mistakes where student_id=#{0} and paper_id=#{1}
	</select>
	<select id="getMyMistakesBy" resultMap="MyMistakesMap">
		select * from tb_my_mistakes
		<where>
			question_id=#{questionId} and student_id=#{studentId}
			<if test="paperId !='' and paperId != null">
				and ts.school_id=#{schoolId}
			</if>
		</where>
	</select>
	<update id="updateMyMistakes" parameterType="com.db.entity.MyMistakes">
		update tb_my_mistakes
		<set>
			update_time=#{updateTime}
			<if test="mistakesNumber != null and mistakesNumber != ''">
				,mistakes_number=#{mistakesNumber}
			</if>
			<if test="currentMistakes != null and currentMistakes != ''">
				,current_mistakes=#{currentMistakes}
			</if>
			where mistakes_id=#{mistakesId}
		</set>
	</update>

	<insert id="addHomeworkMistake" parameterType="com.db.entity.MyMistakes"
		useGeneratedKeys="true" keyProperty="mistakesId">
		insert into tb_my_mistakes
		(student_id,create_time,status,question_id,homework_id
		<if test="mistakesNumber != null and mistakesNumber != ''">
   			<![CDATA[,mistakes_number]]>
		</if>
		<if test="currentMistakes != null and currentMistakes != ''">
   			<![CDATA[,current_mistakes]]>
		</if>
		<if test="value != null and value != ''">
   			<![CDATA[,value]]>
		</if>
		<if test="classId != null and classId != ''">
   			<![CDATA[,class_id]]>
		</if>
		<if test="topicType != null and topicType != ''">
   			<![CDATA[,topic_type]]>
		</if>
		)
		values(#{studentId},#{createTime},#{status},#{questionId},#{homeworkId}
		<if test="mistakesNumber != null and mistakesNumber != ''">
   			<![CDATA[,#{mistakesNumber}]]>
		</if>
		<if test="currentMistakes != null and currentMistakes != ''">
   			<![CDATA[,#{currentMistakes}]]>
		</if>
		<if test="value != null and value != ''">
   			<![CDATA[,#{value}]]>
		</if>
		<if test="classId != null and classId != ''">
   			<![CDATA[,#{classId}]]>
		</if>
		<if test="topicType != null and topicType != ''">
   			<![CDATA[,#{topicType}]]>
		</if>
		)
	</insert>

	<insert id="addPaperMistake" parameterType="com.db.entity.MyMistakes"
		useGeneratedKeys="true" keyProperty="mistakesId">
		insert into tb_my_mistakes
		(student_id,create_time,question_id,paper_id
		<if test="mistakesNumber != null and mistakesNumber != ''">
   			<![CDATA[,mistakes_number]]>
		</if>
		<if test="currentMistakes != null and currentMistakes != ''">
   			<![CDATA[,current_mistakes]]>
		</if>
		<if test="value != null and value != ''">
   			<![CDATA[,value]]>
		</if>
		<if test="classId != null and classId != ''">
   			<![CDATA[,class_id]]>
		</if>
		<if test="topicType != null and topicType != ''">
   			<![CDATA[,topic_type]]>
		</if>
		<if test="subjectId != null">
   			<![CDATA[,subject_id]]>
		</if>
		<if test="status != null">
   			<![CDATA[,status]]>
		</if>
		)
		values(#{studentId},#{createTime},#{questionId},#{paperId}
		<if test="mistakesNumber != null and mistakesNumber != ''">
   			<![CDATA[,#{mistakesNumber}]]>
		</if>
		<if test="currentMistakes != null and currentMistakes != ''">
   			<![CDATA[,#{currentMistakes}]]>
		</if>
		<if test="value != null and value != ''">
   			<![CDATA[,#{value}]]>
		</if>
		<if test="classId != null and classId != ''">
   			<![CDATA[,#{classId}]]>
		</if>
		<if test="topicType != null and topicType != ''">
   			<![CDATA[,#{topicType}]]>
		</if>
		<if test="subjectId != null">
   			<![CDATA[,#{subjectId}]]>
		</if>
		<if test="status != null">
   			<![CDATA[,#{status}]]>
		</if>
		)
	</insert>
	<select id="getRightByStatus" resultMap="MyMistakesMap">
		select * from tb_my_mistakes
		<where>
			student_id=#{studentId} and status=1
			<if test="paperId !='' and paperId != null">
				and paper_id=#{paperId}
			</if>
			<if test="homeworkId !='' and homeworkId != null">
				and homework_id=#{homeworkId}
			</if>
		</where>
	</select>
	<select id="getWrongSingleByTypeandStatus" resultMap="MyMistakesMap">
	select *
	from tb_my_mistakes tm left join tb_question_singlechoice ts
	on
	tm.question_id=ts.choice_id where tm.topic_type=1 and
	tm.status=0
	and tm.student_id=#{studentId} and tm.subject_id = #{subjectId} 
	group by tm.question_id
		<if test="pageSize !=null and pageSize !=''">
			limit #{pageNo},#{pageSize}
		</if>
	</select>
	<select id="getWrongMulitByTypeandStatus" resultMap="MyMistakesMap">
		select *
		from tb_my_mistakes tm left join tb_question_mulitchoice tqm
		on
		tm.question_id=tqm.choice_id where tm.topic_type=2 and
		tm.status=0
		and tm.student_id=#{studentId} and tm.subject_id = #{subjectId} 
		group by tm.question_id
		<if test="pageSize !=null and pageSize !=''">
			limit #{pageNo},#{pageSize}
		</if>
	</select>
	<select id="getWrongJudgeByTypeandStatus" resultMap="MyMistakesMap">
		select *
		from tb_my_mistakes tm left join tb_question_judge tqj on
		tm.question_id=tqj.judge_id where tm.topic_type=3 and
		tm.status=0
		and
		tm.student_id=#{studentId} and tm.subject_id = #{subjectId} 
		group by tm.question_id
		<if test="pageSize !=null and pageSize !=''">
			limit #{pageNo},#{pageSize}
		</if>
	</select>
	<select id="getWrongReadByTypeandStatus" resultMap="MyMistakesMap">
		select * from
		tb_my_mistakes tm left join tb_question_fill tqr on
		tm.question_id=tqr.fill_id where tm.topic_type=6 and
		tm.status=0 and
		tm.student_id=#{studentId} group by tm.question_id
		<if test="pageSize !=null and pageSize !=''">
			limit #{pageNo},#{pageSize}
		</if>
	</select>
	<select id="getMistakeById" resultMap="MyMistakesMap">
		select * from
		tb_my_mistakes where mistakes_id=#{id};
	</select>
	<select id="countThisSubjectMistake" resultType="int">
		select count(*) from tb_my_mistakes where student_id = #{studentId} 
		and subject_id = #{subjectId} and status=0
		<if test="topicType!=null">
			and topic_type =#{topicType}
		</if>
	</select>
	
	<select id="findMyMistakesHomeworkById" resultMap="MyMistakesMap">
	select * from tb_my_mistakes where student_id=#{studentId}
	and question_id=#{questionId} and topic_type=#{type}
	<if test="paperId != null">
		and paper_id=#{paperId}
	</if>
	<if test="homeworkId != null">
		and homework_id=#{homeworkId}
	</if>
	</select>
	
	<update id="updateMyMistakesHomeworkById" parameterType="com.db.entity.MyMistakes">
	update tb_my_mistakes set update_time=#{updateTime},status=#{status}
	where student_id=#{studentId}
	and question_id=#{questionId} and
	topic_type=#{topicType}
	<if test="paperId != null">
		and paper_id=#{paperId}
	</if>
	<if test="homeworkId != null">
		and homework_id=#{homeworkId}
	</if>
</update>
</mapper>