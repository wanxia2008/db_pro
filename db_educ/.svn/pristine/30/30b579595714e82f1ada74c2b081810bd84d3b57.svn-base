<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.db.service.QuestionClozeService">
	<resultMap type="com.db.entity.QuestionCloze" id="ClozeMap">
		<result column="cloze_id" property="clozeId" jdbcType="INTEGER" />
		<result column="cloze_content" property="clozeContent" jdbcType="VARCHAR" />
		<result column="cloze_answer" property="clozeAnswer" jdbcType="VARCHAR" />
		<result column="analysis" property="analysis"
			jdbcType="VARCHAR" />
		<result column="cloze_optionA" property="clozeOptionA" jdbcType="VARCHAR" />
		<result column="cloze_optionB" property="clozeOptionB" jdbcType="VARCHAR" />
		<result column="cloze_optionC" property="clozeOptionC" jdbcType="VARCHAR" />
		<result column="cloze_optionD" property="clozeOptionD" jdbcType="VARCHAR" />
		<result column="subject" property="subject" jdbcType="INTEGER" />
		<result column="knowledge" property="knowledge" jdbcType="INTEGER" />
		<result column="knowledge_begin" property="knowledgeBegin"
			jdbcType="INTEGER" />
		<result column="question_degree" property="questionDegree"
			jdbcType="INTEGER" />
		<result column="question_type" property="type" jdbcType="INTEGER" />
		<result column="question_source" property="questionSource"
			jdbcType="INTEGER" />
			<result column="parent_id" property="parentId" jdbcType="INTEGER" />
			<result column="cloze_son_id" property="clozeSonId" jdbcType="INTEGER" />
		<result column="tag_id" property="tagId" jdbcType="VARCHAR" />
		<result column="teacher_id" property="teacherId" jdbcType="INTEGER" />
		<result column="used_count" property="usedCount" jdbcType="INTEGER" />
		<result column="is_public" property="isPublic" jdbcType="INTEGER" />
		<result column="create_time" property="createTime" />
		<result column="update_time" property="updateTime" />
		
		<association property="questionsType" javaType="com.db.entity.QuestionsType">
			<id column="topic_id" property="topicId" jdbcType="INTEGER" />
			<result column="topic_name" property="topicName" jdbcType="VARCHAR" />
			<result column="create_time" property="createTime" />
			<result column="update_time" property="updateTime" />
			<result column="typic_order" property="typicOrder" jdbcType="INTEGER" />
		</association>
		
		<association property="paperDetails" javaType="com.db.entity.PaperDetails">
			<id property="id" column="id" />
			<result property="questionId" column="question_id" />
			<result property="paperId" column="paper_id" />
			<result property="value" column="value" />
			<result property="number" column="number" />
			<result property="createTime" column="create_time" />
			<result property="paperType" column="paper_type" />
		</association>
		
		<association property="paperAnswer" javaType="com.db.entity.PaperAnswer">
			<id column="answer_id" property="answerId" jdbcType="INTEGER" />
			<result column="paper_id" property="paperId" jdbcType="INTEGER" />
			<result column="write_answer" property="writeAnswer" jdbcType="VARCHAR" />
			<result column="is_true" property="isTrue" jdbcType="INTEGER" />
			<result column="question_type" property="questionType"
				jdbcType="INTEGER" />
		</association>
		
		<association javaType="com.db.entity.HomeworkAnswer" property="homeworkanswer">
			<id column="answer_id" property="answerId" jdbcType="INTEGER" />
			<result column="student_id" property="studentId" jdbcType="INTEGER" />
			<result column="question_id" property="questionId" jdbcType="INTEGER" />
			<result column="question_type" property="questionType"
				jdbcType="INTEGER" />
			<result column="write_answer" property="writeAnswer" jdbcType="VARCHAR" />
			<result column="value" property="value" jdbcType="INTEGER" />
			<result column="paper_id" property="paperId" jdbcType="INTEGER" />
			<result column="is_true" property="isTrue" jdbcType="INTEGER" />
		</association>
		
		<association property="homeworkDetails" javaType="com.db.entity.HomeworkDetails">
			<id property="hdId" column="hd_id" />
			<result column="question_id" property="questionId" jdbcType="INTEGER" />
			<result column="question_type" property="questionType"
				jdbcType="INTEGER" />
			<result column="paper_id" property="paperId" jdbcType="INTEGER" />
			<result column="value" property="value" jdbcType="INTEGER" />
			<result column="create_time" property="createTime" />
			<result column="update_time" property="updateTime" />
		</association>
		<association property="subject2" javaType="com.db.entity.Subject">
			<id column="subject_id" property="subjectId" jdbcType="INTEGER" />
			<result column="subject_name" property="subjectName" jdbcType="VARCHAR" />
		</association>
		
		<association property="grade" javaType="com.db.entity.Grade">
			<id column="grade_id" property="gradeId" jdbcType="INTEGER" />
			<result column="grade_name" property="gradeName" jdbcType="VARCHAR" />
		</association>
		
		<association property="teacher" javaType="com.db.entity.Teacher">
			<id column="teacher_id" property="teacherId" jdbcType="INTEGER" />
			<result column="teacher_name" property="teacherName" jdbcType="VARCHAR" />
		</association>
		
	</resultMap>
	
	<select id="getQuestionClozeList" resultMap="ClozeMap">
	select * from tb_question_cloze c
	left join tb_subject s on c.subject=s.subject_id
	LEFT JOIN tb_teacher t ON c.teacher_id=t.teacher_id
	left join tb_grade g on c.knowledge=g.grade_id
	where c.parent_id is null
	<if test="subject != null">
	and c.subject=#{subject}
</if>
	<if test="isPublic != null">
		and c.is_public=#{isPublic}
	</if>
	<if test="gradeId != null">
		and c.grade=#{gradeId}
	</if>
	order by c.create_time desc limit #{pageNo},#{pageSize}
</select>
<select id="getQuestionClozeCount" resultType="int">
  select count(*) from tb_question_cloze where parent_id is null
  <if test="subject != null">
	and subject=#{subject}
</if>
	<if test="isPublic != null">
		and is_public=#{isPublic}
	</if>
	<if test="gradeId != null">
		and grade=#{gradeId}
	</if>
</select>
<select id="getIsPublicClozeList" resultMap="ClozeMap">
select * from tb_question_cloze c
	left join tb_subject s on c.subject=s.subject_id
	LEFT JOIN tb_teacher t ON c.teacher_id=t.teacher_id
	left join tb_grade g on c.knowledge=g.grade_id
	where c.parent_id is null
	<if test="type==1">
	 and (c.teacher_id=#{teacherId} or c.is_public=1)
	</if>
	<if test="type==2">
	 and c.teacher_id=#{teacherId}
	</if>
	<if test="subject != null">
	and c.subject=#{subject}
   </if>
	<if test="isPublic != null">
		and c.is_public=#{isPublic}
	</if>
	<if test="gradeId != null">
		and c.grade=#{gradeId}
	</if>
	order by c.create_time desc limit #{pageNo},#{pageSize}
</select>
<select id="getIsPublicClozeCount" resultType="int">
 select count(*) from tb_question_cloze where (teacher_id=#{teacherId} or is_public=1) and parent_id is null
  <if test="subject != null">
	and subject=#{subject}
</if>
	<if test="isPublic != null">
		and is_public=#{isPublic}
	</if>
	<if test="gradeId != null">
		and grade=#{gradeId}
	</if>
</select>
<select id="getQuestionClozeById" resultMap="ClozeMap">
   select * from tb_question_cloze where cloze_id=#{clozeId}
</select>
<update id="updateIsPublic" parameterType="com.db.entity.QuestionCloze">
  update tb_question_cloze set update_time=#{updateTime}
  <if test="clozeContent != null and clozeContent !=''">
      ,cloze_content=#{clozeContent}
  </if>
  <if test="subject != null">
      ,subject=#{subject}
  </if>
   <if test="knowledge != null">
      ,knowledge=#{knowledge}
  </if>
  <if test="questionDegree != null">
      ,question_degree=#{questionDegree}
  </if>
   <if test="questionSource != null">
      ,question_source=#{questionSource}
  </if>
   <if test="usedCount != null">
      ,used_count=#{usedCount}
  </if>
   <if test="isPublic != null">
      ,is_public=#{isPublic}
  </if>
  <if test="tagId != null and tagId !=''">
      ,tag_id=#{tagId}
  </if>
   <if test="knowledgeBegin != null">
      ,knowledge_begin=#{knowledgeBegin}
  </if>
   <if test="clozeAnswer != null and clozeAnswer !=''">
      ,cloze_answer=#{clozeAnswer}
  </if>
  <if test="analysis != null and analysis !=''">
      ,analysis=#{analysis}
  </if>
  <if test="clozeOptionA != null and clozeOptionA !=''">
      ,cloze_optionA=#{clozeOptionA}
  </if>
   <if test="clozeOptionB != null and clozeOptionB !=''">
      ,cloze_optionB=#{clozeOptionB}
  </if>
  <if test="clozeOptionC != null and clozeOptionC !=''">
      ,cloze_optionC=#{clozeOptionC}
  </if>
  <if test="clozeOptionD != null and clozeOptionD !=''">
      ,cloze_optionD=#{clozeOptionD}
  </if>
  where cloze_id=#{clozeId}
</update>
<insert id="addQuestionCloze" parameterType="com.db.entity.QuestionCloze"
   useGeneratedKeys="true" keyProperty="clozeId">
 insert into tb_question_cloze (cloze_content,subject,knowledge,question_degree,question_type,question_source,teacher_id,used_count,is_public,tag_id,knowledge_begin,create_time,cloze_answer,analysis,cloze_optionA,cloze_optionB,cloze_optionC,cloze_optionD,parent_id) 
            values(#{clozeContent},#{subject},#{knowledge},#{questionDegree},7,#{questionSource},#{teacherId},0,0,#{tagId},#{knowledgeBegin},#{createTime},#{clozeAnswer},#{analysis},#{clozeOptionA},#{clozeOptionB},#{clozeOptionC},#{clozeOptionD},#{parentId})
</insert>
<delete id="deleteQuestionCloze">
  delete from tb_question_cloze where cloze_id=#{clozeId}
</delete>
<select id="QuestionClozeAdmin" resultMap="ClozeMap">
    select * from tb_question_cloze tqs left join tb_questions_type
		tqt on tqs.question_type=tqt.topic_id
		where parent_id is null
		<if test="teacherId != null">
		and tqs.teacher_id=#{teacherId}
		</if>
		<if test="type !=null">
			and tqs.question_type=#{type}
		</if>
		<if test="subject!=null">
			and tqs.subject=#{subject}
		</if>
		<choose>
			<when test="tags10!=null">
				AND (tqs.tag_id LIKE CONCAT('%','${tags1}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags2}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags3}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags4}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags5}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags6}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags7}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags8}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags9}','%')
			    OR tqs.tag_id LIKE CONCAT('%','${tags10}','%'))
			</when>
			<when test="tags9!=null and tags10==null">
				AND (tqs.tag_id LIKE CONCAT('%','${tags1}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags2}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags3}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags4}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags5}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags6}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags7}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags8}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags9}','%'))
			</when>
			<when test="tags8!=null and tags9==null">
				AND (tqs.tag_id LIKE CONCAT('%','${tags1}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags2}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags3}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags4}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags5}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags6}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags7}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags8}','%'))
			</when>
			<when test="tags7!=null and tags8==null">
				AND (tqs.tag_id LIKE CONCAT('%','${tags1}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags2}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags3}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags4}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags5}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags6}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags7}','%'))
			</when>
			<when test="tags6!=null and tags7==null">
				AND (tqs.tag_id LIKE CONCAT('%','${tags1}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags2}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags3}','%')
			    OR tqs.tag_id LIKE CONCAT('%','${tags4}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags5}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags6}','%'))
			</when>
			<when test="tags5!=null and tags6==null">
				AND (tqs.tag_id LIKE CONCAT('%','${tags1}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags2}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags3}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags4}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags5}','%'))
			</when>
			<when test="tags4!=null and tags5==null">
				AND (tqs.tag_id LIKE CONCAT('%','${tags1}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags2}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags3}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags4}','%'))
			</when>
			<when test="tags3!=null and tags4==null">
				AND (tqs.tag_id LIKE CONCAT('%','${tags1}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags2}','%')
				OR tqs.tag_id LIKE CONCAT('%','${tags3}','%'))
			</when>
			<when test="tags2!=null and tags3==null">
				AND (tqs.tag_id LIKE CONCAT('%','${tags1}','%') 
				OR tqs.tag_id LIKE CONCAT('%','${tags2}','%'))
			</when>
			<when test="tags1!=null and tags2==null">
				AND tqs.tag_id LIKE CONCAT('%','${tags1}','%')
			</when>
		</choose>
		<if test="grade !=null">
			and tqs.knowledge=#{grade}
		</if>
		<if test="science !=null">
			and tqs.question_degree=#{science}
		</if>
		order by rand() limit #{number};
</select>
<select id="findPaperInfoDetails" resultMap="ClozeMap">
select * from
		tb_paper_details h left join tb_question_cloze q on
		h.question_id=q.cloze_id
		where h.paper_id=#{paperId} and
		h.question_type=7
</select>
<select id="getparentByIdList" resultMap="ClozeMap">
select * from tb_question_cloze where parent_id =#{parentId}
</select>

<select id="findHomeworkDetails" resultMap="ClozeMap">
select * from
		td_homework_details h left join tb_question_cloze q on
		h.question_id=q.cloze_id
		where h.paper_id=#{paperId} and
		h.question_type=7
</select>
<select id="thePapersById" resultMap="ClozeMap">
    select * from
	tb_paper_details mp right join tb_question_cloze q on
	mp.question_id=q.cloze_id LEFT JOIN tb_questions_type tqt ON
	mp.question_type=tqt.topic_id where mp.paper_id=#{paperId} and
	mp.question_type=7
</select>
<select id="thePapersAnswerById" resultMap="ClozeMap">
select * from td_paper_answer pa left join tb_question_cloze cc on
		pa.question_id=cc.cloze_id
		LEFT JOIN tb_questions_type qqq ON pa.question_type=qqq.topic_id
		where pa.paper_id=#{paperId} and pa.student_id=#{studentId} and
		pa.question_type=7 and cc.parent_id=#{parentId}
</select>
<select id="theHomeworkDetailsById" resultMap="ClozeMap">
  select * from
	td_homework_answer mp right join tb_question_cloze q on
	mp.question_id=q.cloze_id LEFT JOIN tb_questions_type tqt ON
	mp.question_type=tqt.topic_id where mp.paper_id=#{paperId} and
	mp.question_type=7
</select>
<select id="findHomeworkAnswerById" resultMap="ClozeMap">
select * from td_homework_answer pa left join tb_question_cloze cc on
		pa.question_id=cc.cloze_id
		LEFT JOIN tb_questions_type qqq ON pa.question_type=qqq.topic_id
		where pa.paper_id=#{paperId} and pa.student_id=#{studentId} and
		pa.question_type=7 and cc.parent_id=#{parentId}
</select>
<select id="getQuestionClozeByParentId" resultMap="ClozeMap">
select * from tb_question_cloze where parent_id=#{parentId}
</select>

<select id="theHomeworkById" resultMap="ClozeMap">
select * from
		td_homework_details mp right join tb_question_cloze q on
		mp.question_id=q.cloze_id LEFT JOIN tb_questions_type tqt ON
		mp.question_type=tqt.topic_id
		where mp.paper_id=#{paperId} and mp.question_type=7
</select>
</mapper>