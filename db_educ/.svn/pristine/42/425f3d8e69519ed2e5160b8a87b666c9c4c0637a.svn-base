<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.db.service.StudentCareerService">
	<resultMap type="com.db.entity.StudentCareer" id="StuCareerMap">
		<result column="id" property="Id" jdbcType="INTEGER" />
		<result column="student_id" property="studentId" jdbcType="INTEGER" />
		<result column="class_id" property="classId" jdbcType="INTEGER" />
		<result column="grade" property="grade" jdbcType="INTEGER" />
		<result column="subject" property="subject" jdbcType="INTEGER" />
		<result column="year" property="year" jdbcType="INTEGER" />
		<result column="season_type" property="seasonType" jdbcType="INTEGER" />
		<result column="status" property="status" jdbcType="INTEGER" />
		<result column="school_id" property="schoolId"
			jdbcType="INTEGER" />
		<result column="create_time" property="createTime" />
		<result column="update_time" property="updateTime" />
		<result column="pay_type" property="payType" jdbcType="INTEGER" />
		<result column="is_end_course" property="isEndCourse" jdbcType="INTEGER" />
		
		<association property="student" javaType="com.db.entity.Student">
			<id column="student_id" property="studentId" jdbcType="INTEGER" />
			<result column="student_name" property="studentName" jdbcType="VARCHAR" />
			<result column="sex" property="sex" jdbcType="INTEGER" />
			<result column="age" property="age" jdbcType="INTEGER" />
			<result column="grade" property="grade" jdbcType="INTEGER" />
			<result column="subject_type" property="subjectType" jdbcType="VARCHAR" />
			<result column="student_status" property="studentStatus"
				jdbcType="INTEGER" />
			<result column="create_time" property="createTime" />
			<result column="update_time" property="updateTime" />
			<result column="custodian1_relationship" property="custodian1Relationship"
				jdbcType="VARCHAR" />
			<result column="custodian1_name" property="custodian1Name"
				jdbcType="VARCHAR" />
			<result column="custodian1_phone" property="custodian1Phone"
				jdbcType="VARCHAR" />
			<result column="custodian2_relationship" property="custodian2Relationship"
				jdbcType="VARCHAR" />
			<result column="custodian2_name" property="custodian2Name"
				jdbcType="VARCHAR" />
			<result column="custodian2_phone" property="custodian2Phone"
				jdbcType="VARCHAR" />
			<result column="phone" property="phone" jdbcType="VARCHAR" />
			<result column="attend_school" property="attendSchool"
				jdbcType="VARCHAR" />
			<result column="intentional_school" property="intentionalSchool"
				jdbcType="VARCHAR" />
			<result column="school_id" property="schoolId" jdbcType="INTEGER" />
		</association>
		
		<association property="subjects" javaType="com.db.entity.Subject">
			<id property="subjectId" column="subject_id" />
			<result property="subjectName" column="subject_name" />
		</association>
		
		<association property="grades" javaType="com.db.entity.Grade">
			<id column="grade_id" property="gradeId" jdbcType="INTEGER" />
			<result column="grade_name" property="gradeName" jdbcType="VARCHAR" />
		</association>
		
		<association property="classNo" javaType="com.db.entity.ClassNo">
			<id column="class_id" property="classId" jdbcType="INTEGER" />
			<result column="class_name" property="className" jdbcType="VARCHAR" />
		</association>
		
		<association property="seasonType2" javaType="com.db.entity.SeasonType">
		<id property="seasonId" column="season_id" />
		<result property="seasonName" column="season_name" />
		</association>
		
		<association property="schoolYear" javaType="com.db.entity.SchoolYear">
			<id column="id" property="id" jdbcType="INTEGER" />
			<result column="school_year" property="year" jdbcType="INTEGER" />

		</association>
		
		
		<!-- <association property="classNo2" javaType="com.db.entity.ClassNo"> -->
		<!-- <id property="classId" column="class_id" /> -->
		<!-- <result property="year" column="year" /> -->
		<!-- <result property="seasonType" column="season_type" /> -->
		<!-- <result property="subject" column="subject" /> -->
		<!-- <result property="grade" column="grade" /> -->
		<!-- <result property="className" column="class_name" /> -->
		<!-- <result property="classType" column="class_type" /> -->
		<!-- <result property="classNumber" column="class_number" /> -->
		<!-- <result property="remarks" column="remarks" /> -->
		<!-- <result property="createTime" column="create_time" /> -->
		<!-- <result property="updateTime" column="update_time" /> -->
		<!-- <result property="roomId" column="room_id" /> -->
		<!-- <result property="schoolArea" column="school_area" /> -->
		<!-- </association> -->
		<!-- <collection property="scorelist" resultMap="ScoreMap"></collection> -->
	</resultMap>

	<insert id="addStudentCareer" parameterType="com.db.entity.StudentCareer"
		useGeneratedKeys="true" keyProperty="Id">
		insert into
		td_student_career(create_time
		<if test="studentId !=null and studentId !=''"> 
			<![CDATA[,student_id]]>
		</if>
		<if test="classId !=null and classId !=''"> 
			<![CDATA[,class_id]]>
		</if>
		<if test="grade !=null"> 
			<![CDATA[,grade]]>
		</if>
		<if test="year !=null and year !=''"> 
			<![CDATA[,year]]>
		</if>
		<if test="subject !=null"> 
			<![CDATA[,subject]]>
		</if>
		<if test="seasonType !=null and seasonType !=''"> 
			<![CDATA[,season_type]]>
		</if>
		<if test="status !=null and status !=''"> 
			<![CDATA[,status]]>
		</if>
		
		<if test="payType !=null"> 
			<![CDATA[,pay_type]]>
		</if>
		<if test="schoolId !=null"> 
			<![CDATA[,school_id]]>
		</if>
		)
		values(#{createTime}
		<if test="studentId !=null and studentId !=''"> 
			<![CDATA[,#{studentId}]]>
		</if>
		<if test="classId !=null and classId !=''"> 
			<![CDATA[,#{classId}]]>
		</if>
		<if test="grade !=null"> 
			<![CDATA[,#{grade}]]>
		</if>
		<if test="year !=null and year !=''"> 
			<![CDATA[,#{year}]]>
		</if>
		<if test="subject !=null"> 
			<![CDATA[,#{subject}]]>
		</if>
		<if test="seasonType !=null and seasonType !=''"> 
			<![CDATA[,#{seasonType}]]>
		</if>
		<if test="status !=null"> 
			<![CDATA[,#{status}]]>
		</if>
		
		<if test="payType !=null"> 
			<![CDATA[,#{payType}]]>
		</if>
		<if test="schoolId !=null"> 
			<![CDATA[,#{schoolId}]]>
		</if>
		);
	</insert>

	<!-- 班级添加学员时修改 -->
	<update id="updateCareerWhenAddtoClass" parameterType="com.db.entity.StudentCareer">
		update td_student_career
		<set>
			update_time=#{updateTime},status=#{status}
			<if test="classId !=null and classId !=''">
				,class_id=#{classId}
			</if>
			<if test="seasonType !=null and seasonType !=''">
				,season_type=#{seasonType}
			</if>
		</set>
		where status=1
		<if test="studentId !=null and studentId !=''">
			and student_id=#{studentId}
		</if>
		<if test="subject !=null">
			and subject=#{subject}
		</if>
		<if test="year !=null and year !=''">
			and year=#{year}
		</if>
	</update>
	<!-- 班级删除学生的时候，更新状态 -->
	<update id="updateCareerByStatus" parameterType="com.db.entity.StudentCareer">
		update
		td_student_career set
		update_time=#{updateTime},status=#{status}
		<if test="isEndCourse != NULL">
		,is_end_course=#{isEndCourse}
		</if>
		where student_id=#{studentId} and class_id=#{classId}
	</update>
 <update id="updateCareerBy" parameterType="com.db.entity.StudentCareer">
	update
	td_student_career
	<set>
		update_time=#{updateTime}
		<if test="status != null">
			,status=#{status}
		</if>
		<if test="grade != null">
			,grade=#{grade}
		</if>
		<if test="subject != null">
			,subject=#{subject}
		</if>
		<if test="year != null">
			,year=#{year}
		</if>
		<if test="seasonType != null">
			,season_type=#{seasonType}
		</if>
		<if test="classId != null">
			,class_id=#{classId}
		</if>
		
	</set>
	where id=#{id}
</update>
	<delete id="deleteCareer" parameterType="Integer">
		delete from
		td_student_career where student_id=#{studentId} and
		class_id=#{classId}
	</delete>

	<select id="getStuCareerById" parameterType="Integer" resultMap="StuCareerMap">
		select * from td_student_career where id=#{Id}
	</select>
	
   <select id="findClassIdList" resultMap="StuCareerMap">
		select * from td_student_career where class_id=#{classId}
	</select>

	<!-- 根据学生编号查找班级信息 -->
	<select id="getStuCareerByStu" parameterType="Integer"
		resultMap="StuCareerMap">
		select * from td_student_career c left join tb_school_year y on c.year=y.id 
		left join tb_season_type t on c.season_type=t.season_id where
		c.student_id=#{studentId} and c.class_id is not null order by c.create_time desc;
	</select>

	<!-- 班级按条件搜索学生列表须已缴费的状态 -->
	<select id="getAllStudent" resultMap="StuCareerMap">
		select * from
		td_student_career tsc left join tb_student ts on
		tsc.student_id=ts.student_id left join tb_subject tsb on
		tsc.subject=tsb.subject_id left join tb_grade tg on
		tsc.grade=tg.grade_id
		<where>
			ts.student_status=3 and ts.school_id=#{schoolId} and tsc.class_id is null
			<if test="year !=null and year !=''">
				and tsc.year=#{year}
			</if>
			<if test="subject !=null and subject !=''">
				and tsc.subject=#{subject}
			</if>
			<if test="grade !=null and grade !=''">
				and tsc.grade=#{grade}
			</if>
			<if test="content !=null and content !=''">
				and ts.student_name like '%${content}%'
			</if>
		</where>
		limit #{pageNo},#{pageSize}
	</select>
	<select id="getClassByStudentId" resultMap="StuCareerMap">
		select * from
		td_student_career tsc left join tb_student ts on
		tsc.student_id=ts.student_id left join tb_subject tsb on
		tsc.subject=tsb.subject_id left join tb_grade tg on
		tsc.grade=tg.grade_id
		<where>
			tsc.student_id=#{studentId} and tsc.class_id is not null
			 and tsc.season_type is not null
			 and tsc.season_type=#{seasonId}
			<if test="year !=null and year !=''">
				and tsc.year=#{year}
			</if>
			<if test="subject !=null and subject !=''">
				and tsc.subject=#{subject}
			</if>
			<if test="grade !=null and grade !=''">
				and tsc.grade=#{grade}
			</if>
		</where>
	</select>
	
	<!-- 班级按条件搜索学生列表的总条数 -->
	<select id="getAllStudentCount" resultType="long">
		select COALESCE(count(*),0) from
		td_student_career tsc left join tb_student ts on
		tsc.student_id=ts.student_id left join tb_subject tsb on
		tsc.subject=tsb.subject_id left join tb_grade tg on
		tsc.grade=tg.grade_id
		<where>
			ts.student_status=3 and ts.school_id=#{schoolId} and tsc.class_id is null
			<if test="year !=null and year !=''">
				and tsc.year=#{year}
			</if>
			<if test="subject !=null and subject !=''">
				and tsc.subject=#{subject}
			</if>
			<if test="grade !=null and grade !=''">
				and tsc.grade=#{grade}
			</if>
			<if test="content !=null and content !=''">
				and ts.student_name like '%${content}%'
			</if>
		</where>
	</select>

	<!-- 判断某年某年级某课程该学生是否已经参加了入学考试 -->
	<select id="judgeStudentClass" resultType="long">
		select count(*) from
		td_student_career
		where year=#{year} and subject=#{subject} and
		grade=#{grade} and student_id=#{studentId} and status=1;
	</select>

	<!-- 给班级所在学生分配考试,必须是已分班的状态 -->
	<select id="getStudentByClassNo" parameterType="Integer"
		resultMap="StuCareerMap">
		SELECT * FROM td_student_career tsc 
		  LEFT JOIN tb_student ts ON tsc.student_id=ts.student_id 
		  LEFT JOIN tb_school_year sy ON tsc.year=sy.id
		  LEFT JOIN tb_season_type stt ON tsc.season_type=stt.season_id
		  LEFT JOIN tb_grade g ON tsc.grade=g.grade_id
		  where tsc.class_id=#{classId} and tsc.status=#{status}
	</select>
	<!-- 学生情况 -->
	<select id="getClassListStudent" resultMap="StuCareerMap">
	 select * from td_student_career cn left join tb_student s on cn.student_id=s.student_id
	         left join tb_subject sub ON cn.subject=sub.subject_id  where 1=1
	          <if test="subject != null">
	            and cn.subject=#{subject}
	          </if>
	          <if test="classId != null">
	           and cn.class_id=#{classId}
	          </if>
	          <if test="grade != null">
	           and cn.grade=#{grade}
	          </if>
	</select>
	<delete id="deleteStudentCareerById" parameterType="Integer">
	             delete from td_student_career where id=#{id}
	</delete>
	<select id="getCountStudentId" resultType="int">
	 select count(*) from  td_student_career where student_id=#{studentId}
	</select>
	<select id="getTestRecordStudentId" resultMap="StuCareerMap">
		select * from td_student_career tr left join tb_subject sub on
		tr.subject=sub.subject_id
		left join tb_grade g on tr.grade=g.grade_id
		left join tb_class_no cn on tr.class_id=cn.class_id
		left join tb_school_year sy on tr.year=sy.id
		left join tb_season_type tyy on tr.season_type=tyy.season_id
		where tr.student_id=#{studentId}
<!-- 		left join tb_school_zone sz on tr.school_id=sz.school_id -->
	</select>
	<select id="findStudentCareer" resultMap="StuCareerMap">
	   select * from  td_student_career where student_id=#{studentId} and class_id=#{classId}
	</select>
	<select id="getCountClassNo" resultType="int">
	 select count(*) from td_student_career where class_id=#{classId}
		and status=#{status}
	</select>
	<select id="getCareerGroupByYearAndSeason" resultMap="StuCareerMap">
		select * from td_student_career c left join tb_school_year y on c.year = y.id 
		left join tb_season_type s on c.season_type = s.season_id where c.student_id = #{studentId} 
		and c.class_id is not null group by c.season_type,c.year order by c.create_time desc
	</select>
	<select id="getCareerBySIdAndYearSeason" resultMap="StuCareerMap">
		select * from td_student_career c left join tb_class_no n on c.class_id = n.class_id 
		where c.student_id = #{studentId} and c.season_type 
		= #{seasonType} and c.year = #{year} and c.class_id is not null;
	</select>
	<select id="isDistributionClass" resultMap="StuCareerMap">
	  select * from td_student_career where class_id=#{classId}
	</select>
	<select id="findCareerBySIdAndYearSeason" resultMap="StuCareerMap">
	    select * from td_student_career where student_id=#{studentId} and year=#{year} 
	      and season_type=#{seasonId} and grade=#{gradeId} and subject=#{subject}
	</select>
	<select id="careerList" resultMap="StuCareerMap">
	    select * from td_student_career sc left join tb_student s on sc.student_id=s.student_id
	    left join tb_class_no cn on sc.class_id=cn.class_id
	    left join tb_school_year sy on sc.year=sy.id
	    left join tb_season_type st on sc.season_type=st.season_id
	    left join tb_grade g on sc.grade=g.grade_id
	    left join tb_subject sub on sc.subject=sub.subject_id
	       where sc.student_id=#{studentId} order by sc.create_time desc limit #{pageNo},#{pageSize}
	</select>
	<select id="findCareerGradeId" resultMap="StuCareerMap">
	  select * from td_student_career tsc 
	  left join tb_class_no tcn on tsc.class_id=tcn.class_id 
	  left join tb_subject sub on tsc.subject=sub.subject_id
	  where tsc.student_id=#{studentId} and tsc.grade=#{gradeId}
	</select>
	<update id="updateCareerPayType" parameterType="com.db.entity.StudentCareer">
	update td_student_career set update_time=#{updateTime},pay_type=#{payType} 
	where student_id=#{studentId} and grade=#{gradeId}
	</update>
	
	
	
	
	<update id="updateCareer" parameterType="com.db.entity.StudentCareer">
	  update td_student_career set update_time=#{updateTime},pay_type=#{payType} 
	     where id=#{id}
	</update>
	<update id="updateCareById" parameterType="com.db.entity.StudentCareer">
	  update td_student_career set update_time=now(),is_end_course=1
	  where id=#{id} 
	</update>
</mapper>