<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.db.service.HomeworkService">
	<resultMap id="HomeworkMap" type="com.db.entity.Homework">
		<result column="hk_id" property="hkId" jdbcType="INTEGER" />
		<result column="hk_name" property="hkName" jdbcType="VARCHAR" />
		<result column="subject" property="subject" jdbcType="INTEGER" />
		<result column="grade" property="grade" jdbcType="INTEGER" />
		<result column="science" property="science" jdbcType="INTEGER" />
		<result column="used_times" property="userTimes" jdbcType="INTEGER" />
		<result column="is_public" property="isPublic" jdbcType="INTEGER" />
		<result column="knowledge_begin" property="knowledgeBegin"
			jdbcType="INTEGER" />
		<result column="knowledge_end" property="knowledgeEnd"
			jdbcType="INTEGER" />
		<result column="difficulty_value" property="difficultyValue"
			jdbcType="INTEGER" />
		<result column="teacher_id" property="teacherId" jdbcType="INTEGER" />
		<result column="teacher_name" property="teacherName" jdbcType="VARCHAR" />
		<result column="hk_total" property="hkTotal" jdbcType="INTEGER" />
		<result column="hk_score" property="hkScore" jdbcType="DOUBLE" />
		<result column="create_time" property="createTime" />
		<result column="update_time" property="updateTime" />
		<result column="is_start" property="isStart" jdbcType="INTEGER" />
		<association property="subject2" javaType="com.db.entity.Subject">
			<id property="subjectId" column="subject_id" />
			<result property="subjectName" column="subject_name" />
		</association>
		
		<association property="grade2" javaType="com.db.entity.Grade">
			<id property="gradeId" column="grade_id" />
			<result property="gradeName" column="grade_name" />
		</association>
		
		<!--连表3 -->
		<association property="homeworkAnswer" javaType="com.db.entity.HomeworkAnswer">
			<id column="answer_id" property="answerId" jdbcType="INTEGER" />
			<result column="student_id" property="studentId" jdbcType="INTEGER" />
			<result column="question_id" property="questionId" jdbcType="INTEGER" />
			<result column="question_type" property="questionType"
				jdbcType="INTEGER" />
			<result column="create_time" property="createTime" />
			<result column="write_answer" property="writeAnswer" jdbcType="VARCHAR" />
			<result column="value" property="value" jdbcType="INTEGER" />
			<result column="paper_id" property="paperId" jdbcType="INTEGER" />
			<result column="is_complete" property="isComplete" jdbcType="INTEGER" />
		</association>
	</resultMap>


	<!-- Jerry -->
	<select id="getHomeworkByTeacherId" resultMap="HomeworkMap">
	select * from
	td_homework th left join tb_subject ts on
	th.subject=ts.subject_id
	left join tb_grade g on th.grade=g.grade_id
	where th.teacher_id=#{teacherId}
	<if test="hk.hkName != null and hk.hkName != ''">
	and th.hk_name like CONCAT('%','${hk.hkName}','%')
    </if>
	<if test="hk.subject != null and hk.subject != ''">
		and th.subject=#{hk.subject}
	</if>
	<if test="hk.grade != null and hk.grade != ''">
		and th.grade=#{hk.grade}
	</if>
	<if test="hk.isPublic != null">
		and is_public=#{hk.isPublic}
	</if>
	<if test="subjectId != null">
		and th.subject=#{subjectId}
	</if>
	<if test="gradeId != null">
		and th.grade=#{gradeId}
	</if>
	order by th.create_time desc
	limit #{pageNo},#{pageSize};
	</select>
	
	<select id="getHomeworkByTeacherId1" resultMap="HomeworkMap">
	select * from
	td_homework th left join tb_subject ts on
	th.subject=ts.subject_id
	left join tb_grade g on th.grade=g.grade_id
	where th.teacher_id=#{teacherId} and th.is_start = 1
	<if test="hk.hkName != null and hk.hkName != ''">
	and th.hk_name like CONCAT('%','${hk.hkName}','%')
    </if>
	<if test="hk.subject != null and hk.subject != ''">
		and th.subject=#{hk.subject}
	</if>
	<if test="hk.grade != null and hk.grade != ''">
		and th.grade=#{hk.grade}
	</if>
	<if test="hk.isPublic != null">
		and is_public=#{hk.isPublic}
	</if>
	<if test="subjectId != null">
		and th.subject=#{subjectId}
	</if>
	<if test="gradeId != null">
		and th.grade=#{gradeId}
	</if>
	order by th.create_time desc
	limit #{pageNo},#{pageSize};
	</select>
	
	<select id="getHomeworkByTeacherIdIsPublic" resultMap="HomeworkMap">
		select * from
		td_homework th left join tb_subject ts on
		th.subject=ts.subject_id
		left join tb_grade g on th.grade=g.grade_id
		where (th.teacher_id=#{teacherId} or th.is_public=1)
		<if test="hk.hkName != null and hk.hkName != ''">
			and th.hk_name like CONCAT('%','${hk.hkName}','%')
		</if>

		<if test="hk.subject != null and hk.subject != ''">
			and th.subject=#{hk.subject}
		</if>
		<if test="hk.grade != null and hk.grade != ''">
			and th.grade=#{hk.grade}
		</if>
		<if test="hk.isPublic != null">
			and is_public=#{hk.isPublic}
		</if>
		order by th.create_time desc
		limit #{pageNo},#{pageSize};
	</select>

<select id="getHomeworkByTeacherIdIsPublicbyids" resultMap="HomeworkMap">
		select * from
		td_homework th left join tb_subject ts on
		th.subject=ts.subject_id
		left join tb_grade g on th.grade=g.grade_id
		where (th.teacher_id=#{teacherId} or th.is_public=1)
		<if test="hk.hkName != null and hk.hkName != ''">
			and th.hk_name like CONCAT('%','${hk.hkName}','%')
		</if>

		<if test="hk.subject != null and hk.subject != ''">
			and th.subject=#{hk.subject}
		</if>
		<if test="hk.grade != null and hk.grade != ''">
			and th.grade=#{hk.grade}
		</if>
		
		<if test="gradeList != null">
			and th.grade in 
			<foreach collection="gradeList" item = "id" open="(" separator=","  close=")" >
			#{id}
			</foreach>
		</if>
		<if test="hk.isPublic != null">
			and is_public=#{hk.isPublic}
		</if>
		order by th.create_time desc
		limit #{pageNo},#{pageSize};
	</select>

	<!-- 新增试卷 -->
	<insert id="addHomework" parameterType="com.db.entity.PaperInfo"
		useGeneratedKeys="true" keyProperty="hkId">
		insert into td_homework
		(hk_name,subject,grade,is_public,teacher_id,teacher_name,hk_total,hk_score,create_time
		<if test="userTimes!=null and userTimes!=''">
      		<![CDATA[,used_times]]>
		</if>

		<if test="knowledgeBegin!=null and knowledgeBegin!=''">
      		<![CDATA[,knowledge_begin]]>
		</if>
		<if test="knowledgeEnd!=null and knowledgeEnd!=''">
      		<![CDATA[,knowledge_end]]>
		</if>
		<if test="difficultyValue!=null and difficultyValue!=''">
      		<![CDATA[,difficulty_value]]>
		</if>
		<if test="science !=null">
      		<![CDATA[,science]]>
		</if>
		)
		values(#{hkName},#{subject},#{grade},#{isPublic},#{teacherId},#{teacherName},#{hkTotal},#{hkScore},#{createTime}
		<if test="userTimes!=null and userTimes!=''">
      <![CDATA[,#{userTimes}]]>
		</if>
		<if test="knowledgeBegin!=null and knowledgeBegin!=''">
      <![CDATA[,#{knowledgeBegin}]]>
		</if>
		<if test="knowledgeEnd!=null and knowledgeEnd!=''">
      <![CDATA[,#{knowledgeEnd}]]>
		</if>
		<if test="difficultyValue!=null and difficultyValue!=''">
      <![CDATA[,#{difficultyValue}]]>
		</if>
		<if test="science !=null">
      		<![CDATA[,#{science}]]>
		</if>
		)
	</insert>
	<select id="getHomeworkById" parameterType="Integer" resultMap="HomeworkMap">
		select * from td_homework where hk_id=#{hkId};
	</select>
	<update id="updateHomeworkById" parameterType="com.db.entity.Homework">
		update td_homework
		<set>
			update_time=#{updateTime}
			<if test="hkName != null and hkName != ''">
				,hk_name=#{hkName}
			</if>
			<if test="subject != null and subject != ''">
				,subject=#{subject}
			</if>
			<if test="grade != null and grade != ''">
				,grade=#{grade}
			</if>
			<if test="science != null and science != ''">
				,science=#{science}
			</if>
			<if test="difficultyValue != null and difficultyValue != ''">
				,difficulty_value=#{difficultyValue}
			</if>
			<if test="knowledgeBegin != null and knowledgeBegin != ''">
				,knowledge_begin=#{knowledgeBegin}
			</if>
			<if test="knowledgeEnd != null and knowledgeEnd != ''">
				,knowledge_end=#{knowledgeEnd}
			</if>
			<if test="isPublic != null and isPublic != ''">
				,is_public=#{isPublic}
			</if>
			<if test="hkTotal != null and hkTotal != ''">
				,hk_total=#{hkTotal}
			</if>
			<if test="hkScore != null and hkScore != ''">
				,hk_score=#{hkScore}
			</if>
		</set>
		where hk_id=#{hkId}
	</update>
	<select id="findPaperId" resultMap="HomeworkMap">
		select * from td_homework
		where paper_id=#{paperId} and
		student_id=#{studentId}
	</select>
	<!-- Jerry -->


	<insert id="saveHomework" parameterType="com.db.entity.Homework"
		useGeneratedKeys="true" keyProperty="homeworkId">
		insert into
		td_homework(start_time,teacher_id,homework_type,paper_id,create_time
		<if test="endTime != null and endTime != ''">
         <![CDATA[,end_time]]>
		</if>
		<if test="total != null and total != ''">
         <![CDATA[,total]]>
		</if>
		<if test="subject != null and subject != ''">
         <![CDATA[,subject]]>
		</if>
		<if test="value != null and value != ''">
         <![CDATA[,value]]>
		</if>
		<if test="completeTotal != null and completeTotal != ''">
         <![CDATA[,complete_total]]>
		</if>
		<if test="materialScience != null and materialScience != ''">
         <![CDATA[,material_science]]>
		</if>
		<if test="homeworkName != null and homeworkName != ''">
         <![CDATA[,homework_name]]>
		</if>
		<if test="difficulty != null and difficulty != ''">
         <![CDATA[,difficulty]]>
		</if>
		<if test="buildUserName != null and buildUserName != ''">
         <![CDATA[,build_user_name]]>
		</if>

		<if test="grade != null and grade != ''">
         <![CDATA[,grade]]>
		</if>
		<if test="piType != null and piType != ''">
         <![CDATA[,pi_type]]>
		</if>
		<if test="seasonType != null and seasonType != ''">
         <![CDATA[,season_type]]>
		</if>
		)
		values(#{startTime},#{teacherId},#{homeworkType},#{paperId},#{createTime}
		<if test="endTime != null and endTime != ''">
             <![CDATA[,#{endTime}]]>
		</if>
		<if test="total != null and total != ''">
         <![CDATA[,#{total}]]>
		</if>
		<if test="subject != null and subject != ''">
         <![CDATA[,#{subject}]]>
		</if>
		<if test="value != null and value != ''">
         <![CDATA[,#{value}]]>
		</if>
		<if test="completeTotal != null and completeTotal != ''">
         <![CDATA[,#{completeTotal}]]>
		</if>
		<if test="materialScience != null and materialScience != ''">
         <![CDATA[,#{materialScience}]]>
		</if>
		<if test="homeworkName != null and homeworkName != ''">
         <![CDATA[,#{homeworkName}]]>
		</if>
		<if test="difficulty != null and difficulty != ''">
         <![CDATA[,#{difficulty}]]>
		</if>
		<if test="buildUserName != null and buildUserName != ''">
         <![CDATA[,#{buildUserName}]]>
		</if>

		<if test="grade != null and grade != ''">
         <![CDATA[,#{grade}]]>
		</if>
		<if test="piType != null and piType != ''">
         <![CDATA[,#{piType}]]>
		</if>
		<if test="seasonType != null and seasonType != ''">
         <![CDATA[,#{seasonType}]]>
		</if>
		)
	</insert>
	<select id="getHomework" resultMap="HomeworkMap">
		select * from td_homework
		where hk_id=#{homeworkId}
	</select>
	<select id="getHomeworkId" resultMap="HomeworkMap">
		select * from td_homework h left join tb_subject j on
		h.subject=j.subject_id where h.student_id=#{userId}
		<!-- 模糊查询 -->
		<if test="hk.homeworkType != null and hk.homeworkType != ''">
			and h.homework_type=#{hk.homeworkType}
		</if>
		<if test="hk.subject != null and hk.subject != ''">
			and h.subject=#{hk.subject}
		</if>
		<if test="hk.materialScience != null and hk.materialScience != ''">
			and h.material_science=#{hk.materialScience}
		</if>
		<if test="hk.grade != null and hk.grade != ''">
			and h.grade=#{hk.grade}
		</if>
		<if test="hk.isPublic != null">
			and is_public=#{hk.isPublic}
		</if>
		<!-- limit #{pageNo},#{pageSize} -->
	</select>
	<delete id="deleteBomeworkById" parameterType="java.lang.Integer">
		delete from
		td_homework where hk_id=#{homeworkId}
	</delete>
	<select id="getCountToatai" resultType="java.lang.Integer">

		select count(*) from
		td_homework
	</select>
	<update id="updateStatus" parameterType="com.db.entity.Homework">

		update td_homework set
		update_time=#{updateTime},status=#{status}
		where
		hk_id=#{homeworkId}
	</update>

	<select id="getCountId" resultType="java.lang.Integer">
		select count(*) from
		td_homework where teacher_id=#{teacherId}
		<if test="hk.hkName != null and hk.hkName != ''">
			and hk_name like CONCAT('%','${hk.hkName}','%')
		</if>

		<if test="hk.subject != null and hk.subject != ''">
			and subject=#{hk.subject}
		</if>
		<if test="hk.grade != null and hk.grade != ''">
			and grade=#{hk.grade}
		</if>
		<if test="hk.isPublic != null">
			and is_public=#{hk.isPublic}
		</if>
	</select>
	<select id="getCountIspublicId" resultType="java.lang.Integer">
		select count(*) from
		td_homework where (teacher_id=#{teacherId} or is_public=1)
		<if test="hk.hkName != null and hk.hkName != ''">
			and hk_name like CONCAT('%','${hk.hkName}','%')
		</if>

		<if test="hk.subject != null and hk.subject != ''">
			and subject=#{hk.subject}
		</if>
		<if test="hk.grade != null and hk.grade != ''">
			and grade=#{hk.grade}
		</if>
		<if test="hk.isPublic != null">
			and is_public=#{hk.isPublic}
		</if>
	</select>
	
	<select id="getCountIspublicIdbyids" resultType="java.lang.Integer">
		select count(*) from
		td_homework where (teacher_id=#{teacherId} or is_public=1)
		<if test="hk.hkName != null and hk.hkName != ''">
			and hk_name like CONCAT('%','${hk.hkName}','%')
		</if>

		<if test="hk.subject != null and hk.subject != ''">
			and subject=#{hk.subject}
		</if>
		<if test="gradeList != null">
			and grade in 
			<foreach collection="gradeList" item = "id" open="(" separator=","  close=")" >
			#{id}
			</foreach>
		</if>
		<if test="hk.isPublic != null">
			and is_public=#{hk.isPublic}
		</if>
	</select>
	
	<update id="updateIspublic" parameterType="com.db.entity.Homework">
		update td_homework set update_time=#{updateTime},is_public=#{isPublic}
		 where hk_id=#{hkId}
	</update><!-- hkScore -->
	<update id="updateIsstart" parameterType="com.db.entity.Homework">
	   update td_homework set update_time=#{updateTime},is_start = #{isStart} where hk_id = #{hkId}
	</update>
	<update id="updateTotal" parameterType="com.db.entity.Homework">
	update td_homework
	<set>
		update_time=#{updateTime}
		<if test="hkTotal != null">
			,hk_total=#{hkTotal}
		</if>
		<if test="hkScore != null">
			,hk_score=#{hkScore}
		</if>
	</set>
	where hk_id=#{hkId}
</update>
	<select id="getScience" resultMap="HomeworkMap">
	   select * from td_homework where science=#{materialId}
	</select>
	<select id="getknowledgeBegin" resultMap="HomeworkMap"> 
	select * from td_homework where knowledge_begin=#{lessonId} or knowledge_end=#{lessonId}
	</select>
	<select id="seeCountId" resultType="java.lang.Integer">
		select count(*) from
		td_homework where 1=1
		<if test="hk.hkName != null and hk.hkName != ''">
			and hk_name like CONCAT('%','${hk.hkName}','%')
		</if>

		<if test="hk.subject != null">
			and subject=#{hk.subject}
		</if>
		<if test="hk.grade != null">
			and grade=#{hk.grade}
		</if>
		<if test="hk.isPublic != null">
			and is_public=#{hk.isPublic}
		</if>
		
		<if test="subjectId != null">
			and subject=#{subjectId}
		</if>
		<if test="gradeId != null">
			and grade=#{gradeId}
		</if>
	</select>
	<select id="seeCountId1" resultType="java.lang.Integer">
		select count(*) from
		td_homework where 1=1 and is_start = 1
		<if test="hk.hkName != null and hk.hkName != ''">
			and hk_name like CONCAT('%','${hk.hkName}','%')
		</if>

		<if test="hk.subject != null">
			and subject=#{hk.subject}
		</if>
		<if test="hk.grade != null">
			and grade=#{hk.grade}
		</if>
		<if test="hk.isPublic != null">
			and is_public=#{hk.isPublic}
		</if>
		
		<if test="subjectId != null">
			and subject=#{subjectId}
		</if>
		<if test="gradeId != null">
			and grade=#{gradeId}
		</if>
	</select>
	<select id="seeHomeworkByTeacherId" resultMap="HomeworkMap">
		select * from
		td_homework th left join tb_subject ts on
		th.subject=ts.subject_id
		left join tb_grade g on th.grade=g.grade_id
		where 1=1
		<if test="hk.hkName != null and hk.hkName != ''">
			and th.hk_name like CONCAT('%','${hk.hkName}','%')
		</if>

		<if test="hk.subject != null">
			and th.subject=#{hk.subject}
		</if>
		<if test="hk.grade != null">
			and th.grade=#{hk.grade}
		</if>
		<if test="hk.isPublic != null">
			and th.is_public=#{hk.isPublic}
		</if>
		<if test="subjectId != null">
			and th.subject=#{subjectId}
		</if>
		<if test="gradeId != null">
			and th.grade=#{gradeId}
		</if>
		order by th.create_time desc
		limit #{pageNo},#{pageSize};
	</select>
	<select id="seeHomeworkByTeacherId1" resultMap="HomeworkMap">
		select * from
		td_homework th left join tb_subject ts on
		th.subject=ts.subject_id
		left join tb_grade g on th.grade=g.grade_id
		where 1=1 and th.is_start = 1
		<if test="hk.hkName != null and hk.hkName != ''">
			and th.hk_name like CONCAT('%','${hk.hkName}','%')
		</if>

		<if test="hk.subject != null">
			and th.subject=#{hk.subject}
		</if>
		<if test="hk.grade != null">
			and th.grade=#{hk.grade}
		</if>
		<if test="hk.isPublic != null">
			and th.is_public=#{hk.isPublic}
		</if>
		<if test="subjectId != null">
			and th.subject=#{subjectId}
		</if>
		<if test="gradeId != null">
			and th.grade=#{gradeId}
		</if>
		order by th.create_time desc
		limit #{pageNo},#{pageSize};
	</select>
	<update id="updateUserTimes" parameterType="com.db.entity.Homework">
	update td_homework set update_time=#{updateTime},used_times=#{userTimes}
		 where hk_id=#{hkId}
	</update>
	<select id="getSubjectById" resultMap="HomeworkMap">
	select * from td_homework where subject=#{subjectId}
	</select>
	<select id="getConutHomework" resultType="int">
	select count(*) from td_homework where 1=1
	<choose>
		<when test="type == 5 or type == 6">
			and (teacher_id=#{teacherId} and is_public=1)
		</when>
	</choose>
	</select>
	
	<select id="getIsPublicHomework" resultType="int">
	select count(*) from td_homework where 1=1
	<choose>
		<when test="type == 5 or type == 6">
			and (teacher_id=#{teacherId} and is_public=1)
		</when>
		<otherwise>
			and is_public=1
		</otherwise>
	</choose>
	</select>
	
	
	<select id="getHomeworkByTeacherIdCount" resultType="int">
	select count(*) from td_homework where teacher_id=#{teacherId} or is_public=1
	<if test="gradeId != null">
	and grade=#{gradeId}
	</if>
	<if test="subjectId != null">
	and subject=#{subjectId}
	</if>
	</select>
	
	<select id="getHomeworkByTeacherIdCount1" resultType="int">
	select count(*) from td_homework where teacher_id=#{teacherId} or is_public=1 and is_start = 1
	<if test="gradeId != null">
	and grade=#{gradeId}
	</if>
	<if test="subjectId != null">
	and subject=#{subjectId}
	</if>
	</select>
</mapper> 