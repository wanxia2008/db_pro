<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.db.service.PaperAnswerService">
   <resultMap type="com.db.entity.PaperAnswer" id="PaperAnswerMap">
      <result column="answer_id" property="answerId"  jdbcType="INTEGER" />
      <result column="student_id" property="studentId"  jdbcType="INTEGER" />
      <result column="question_id" property="questionId"  jdbcType="INTEGER" />
      <result column="question_type" property="questionType"  jdbcType="INTEGER" />
       <result column="create_time" property="createTime" />
      <result column="subject_type" property="subjectType"  jdbcType="INTEGER" />
       <result column="write_answer" property="writeAnswer" jdbcType="VARCHAR" />
      <result column="value" property="value"  jdbcType="DOUBLE" />
       <result column="paper_id" property="paperId"  jdbcType="INTEGER" />
       <result column="is_true" property="isTrue"  jdbcType="INTEGER" />
       <result column="class_id" property="classId"  jdbcType="INTEGER" />
       
      <association property="student" javaType="com.db.entity.Student">
	<id column="student_id" property="studentId" jdbcType="INTEGER" />
	<result column="student_name" property="studentName" jdbcType="VARCHAR" />
	<result column="sex" property="sex" jdbcType="INTEGER" />
	<result column="age" property="age" jdbcType="INTEGER" />
	<result column="grade" property="grade" jdbcType="INTEGER" />
	<result column="class_no" property="classNo" jdbcType="VARCHAR" />
	</association>
   </resultMap>
   
   <insert id="savePaperAnswer" parameterType="com.db.service.PaperAnswerService" 
           useGeneratedKeys="true" keyProperty="answerId">
      insert into td_paper_answer (student_id,question_id,create_time,write_answer
      <if test="questionType != null and questionType != ''">
       <![CDATA[,question_type]]>
      </if>
       <if test="subjectType != null and subjectType != ''">
       <![CDATA[,subject_type]]>
      </if>
       <if test="paperId != null and paperId != ''">
       <![CDATA[,paper_id]]>
      </if>
       <if test="value != null and value != ''">
       <![CDATA[,value]]>
      </if>
       <if test="classId != null">
       <![CDATA[,class_id]]>
      </if>
      ) 
        values(#{studentId},#{questionId},#{createTime},#{writeAnswer}
        <if test="questionType != null and questionType != ''">
       <![CDATA[,#{questionType}]]>
      </if>
       <if test="subjectType != null and subjectType != ''">
       <![CDATA[,#{subjectType}]]>
      </if>
       <if test="paperId != null and paperId != ''">
       <![CDATA[,#{paperId}]]>
      </if>
       <if test="value != null and value != ''">
       <![CDATA[,#{value}]]>
      </if>
       <if test="classId != null">
       <![CDATA[,#{classId}]]>
      </if>
        )
   </insert>
   <select id="getPaperById" resultMap="PaperAnswerMap">
      select * from td_paper_answer where answer_id=#{answerId}
   </select>
   <select id="findPaperAnswerBy" resultMap="PaperAnswerMap">
       select * from td_paper_answer where student_id=#{studentId} and paper_id=#{paperId};
   </select>
   
   <select id="getcountTrue" resultType="Integer">
	select count(*) from td_paper_answer
	where paper_id=#{paperId} and is_true=#{isTrue}
	<if test="studentId != null">
		and student_id=#{studentId}
	</if>
	<if test="type != null">
		and question_type=#{type}
	</if>
	<if test="classId != null">
		and class_id=#{classId}
	</if>
	<if test="questionId != null">
		and question_id=#{questionId}
	</if>
</select>
   
    <select id="getcountFlase" resultType="Integer">
   select count(*) from td_paper_answer 
      where student_id=#{studentId} and paper_id=#{paperId} and is_true=#{isTrue}
   </select>
   
   <update id="updateIsTrue" parameterType="com.db.entity.PaperAnswer"
	useGeneratedKeys="true" keyProperty="answerId">
	update td_paper_answer
	<set>
		<if test="isTrue != null">
			is_true=#{isTrue}
		</if>
		<if test="writeAnswer != null and writeAnswer != ''">
			,write_answer=#{writeAnswer}
		</if>
	</set>
	where answer_id=#{answerId}
</update>
<update id="updateWriteAnswer" parameterType="com.db.entity.PaperAnswer"
	useGeneratedKeys="true" keyProperty="answerId">
	update td_paper_answer
	<set>
		question_id=#{questionId},write_answer=#{writeAnswer}
		<if test="value != null">
			,value=#{value}
		</if>
		<if test="classId != null">
			,class_id=#{classId}
		</if>
	</set>
	where answer_id=#{answerId}
</update>
   
   <select id="getCountwhenWriting" resultType="Integer">
   		select count(*) from td_paper_answer where student_id=#{studentId} and paper_id=#{paperId};
   </select>
   
   <!-- 查找做过该道题的信息，包括选A、B、C、D的数量 -->
   <select id="getMessageByQuestion" resultMap="PaperAnswerMap">
   		SELECT * from td_paper_answer where question_id=#{questionId} and question_type=#{type};
   </select>
   <select id="findPaerIdById" resultMap="PaperAnswerMap">
     select * from td_paper_answer where paper_id=#{paperId};
   </select>
   <select id="isdoPaperIdById" resultMap="PaperAnswerMap">
     select * from td_paper_answer where student_id=#{studentId} and paper_id=#{paperId} 
        and question_id=#{questionId} and question_type=#{questionType}
   </select>
   <select id="findClassPaperInfoAnalysisList" resultMap="PaperAnswerMap">
    SELECT DISTINCT question_type,question_id FROM td_paper_answer 
    WHERE paper_id=#{paperId} and class_id=#{classId}
     order by question_type asc limit #{pageNo},#{pageSize}
   </select>
   <select id="getAnalysisCount" resultType="int">
    SELECT COUNT(DISTINCT question_type,question_id) AS answer_id FROM td_paper_answer
    WHERE paper_id=#{paperId} and class_id=#{classId}
   </select>
   
   <select id="findStudentInformation" resultMap="PaperAnswerMap">
     select * from td_paper_answer pa left join tb_student s on pa.student_id=s.student_id
         where pa.paper_id=#{paperId} and pa.class_id=#{classId} and pa.is_true=#{isTrue} and pa.question_id=#{questionId}
          and pa.question_type=#{type}
         order by pa.question_type asc limit #{pageNo},#{pageSize}
   </select>
   <select id="findStudentInformationCount" resultType="int">
   select count(*) from td_paper_answer where paper_id=#{paperId} 
   and class_id=#{classId} and is_true=#{isTrue} and question_id=#{questionId} and question_type=#{type}
   </select>
	<select id="getQuestionAvg" resultType="double">
		select avg(value) from td_paper_answer where paper_id=#{paperId}
		and class_id=#{classId} and question_type=#{type}
	</select>
</mapper>