package com.db.timer;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

import javax.annotation.Resource;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;

import com.db.action.ExamController;
import com.db.entity.ClassNo;
import com.db.entity.ClassRecord;
import com.db.entity.PaperInfo;
import com.db.entity.Task;
import com.db.service.ClassNoService;
import com.db.service.ClassRecordService;
import com.db.service.PaperInfoService;
import com.db.service.TaskService;

public class TaskMarkTimer {

	@Autowired
	private TaskService taskService;
	@Resource
	private ClassRecordService ClassRecordService;
	@Resource
	private ClassNoService classnoservice;
	@Resource
	private PaperInfoService paperinfoservice;

	private Logger log = Logger.getLogger(ExamController.class);

	public void calculate() throws ParseException {
		List<Task> taskList = taskService.getStarTaskList();
		log.info("进入任务列表");
		Date date = new Date();
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
		if (taskList != null && !taskList.isEmpty()) {
			for (Task ta : taskList) {
				log.info("开始启动任务");
				if (sdf.parse(sdf.format(date)).getTime() >= sdf.parse(sdf.format(ta.getCreateTime())).getTime()) {
					if (ta.getTaskObjectClass() != null) {
						String[] classnos = ta.getTaskObjectClass().split(",");
						for (int i = 0; i < classnos.length; i++) {
							ClassRecord course = ClassRecordService.getPaperById(Integer.valueOf(classnos[i]),
									Integer.valueOf(ta.getTaskCount()), null, null);
							if (course == null) {
								// 根据班级编号往课程表李添加数据
								course = new ClassRecord();
								ClassNo classNo = classnoservice.getClassById(Integer.valueOf(classnos[i]));
								course.setCreateTime(new Date());
								course.setClassId(classNo.getClassId());
								course.setStatus(1);
								course.setTaskId(ta.getTaskId());
								course.setPaperId(ta.getTaskCount());
								ClassRecordService.addClassRecord(course);
							} else {
								course.setUpdateTime(new Date());
								course.setStatus(1);// 任务
								course.setPaperId(ta.getTaskCount());
								ClassRecordService.updateStatus(course);

							}
						}
						// 试卷使用总数加一
						PaperInfo info = paperinfoservice.getPaperInfoById(ta.getTaskCount());
						if (info != null) {
							info.setUpdateTime(new Date());
							if (String.valueOf(info.getUsedTimes()) != null) {
								info.setUsedTimes(info.getUsedTimes() + 1);
							} else {
								info.setUsedTimes(1);
							}
							paperinfoservice.updateUsertimes(info);// 更新试卷引用数
						}
						ta.setUpdateTime(new Date());
						ta.setTaskStatus(1);
						ta.setTaskId(ta.getTaskId());
						taskService.updateTask(ta);
						log.info("启动任务结束");
					}
				}
			}
		} else {
			log.info("没有哟启动的任务");
		}
	}
}
